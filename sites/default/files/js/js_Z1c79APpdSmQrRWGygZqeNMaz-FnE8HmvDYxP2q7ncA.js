/* @license GPL-2.0-or-later https://www.drupal.org/licensing/faq */
(function(Drupal,drupalSettings){'use strict';Drupal.behaviors.deepChatToggle={chats:[],initialized:false,csrfToken:'',shouldContinue:false,stepMessages:[],agentUsageIsOpen:false,processing:false,attach:function(context,settings){if(Drupal.behaviors.deepChatToggle.initialized)return;const chatContainers=context.querySelectorAll('.chat-container');const dropDownMenu=context.querySelector('.chat-dropdown');if(!dropDownMenu)return;Drupal.behaviors.deepChatToggle.initialized=true;const chevron=context.querySelector('.chevron-icon');const menuButton=dropDownMenu.querySelector('.chat-dropdown-button');const clearHistory=dropDownMenu.querySelector('.clear-history');let pendingRenders=chatContainers.length;chatContainers.forEach((container)=>{if(container.dataset.deepChatToggleInitialized)return;container.dataset.deepChatToggleInitialized='true';const chatId=container.getAttribute('data-chat-id');if(!chatId){console.warn('Chat container is missing a data-chat-id attribute.');return;}const header=container.querySelector('.ai-deepchat--header');if(!header){console.warn('Header with class .ai-deepchat--header not found in container:',container);return;}const chatElement=container.querySelector('.chat-element');if(!chatElement){console.warn('Chat element with class .chat-element not found in container:',container);return;}const toggleIcon=header.querySelector('.toggle-icon');const deepchatElement=container.querySelector('.deepchat-element');Drupal.behaviors.deepChatToggle.chats.push(deepchatElement);const setThreadId=(thread_id)=>{let connect=JSON.parse(deepchatElement.getAttribute('connect'));connect.additionalBodyProps.thread_id=thread_id;deepchatElement.setAttribute('connect',JSON.stringify(connect));drupalSettings.ai_deepchat.thread_id=thread_id;};setThreadId(drupalSettings.ai_deepchat.thread_id);const updateToggleIcon=(isOpen)=>{if(toggleIcon){toggleIcon.classList.toggle('is-opened',!isOpen);toggleIcon.classList.toggle('is-closed',isOpen);}};const openChat=()=>{container.classList.add('chat-open');container.classList.remove('chat-collapsed');container.classList.remove('chat-collapsed-minimal');header.classList.add('active');header.setAttribute('aria-expanded','true');if(toggleIcon)updateToggleIcon(true);localStorage.setItem(`deepChatState_${chatId}`,'open');};const closeChat=()=>{container.classList.add('chat-collapsed');if(drupalSettings.ai_deepchat.collapse_minimal)container.classList.add('chat-collapsed-minimal');container.classList.remove('chat-open');header.classList.remove('active');header.setAttribute('aria-expanded','false');if(toggleIcon)updateToggleIcon(false);localStorage.removeItem(`deepChatState_${chatId}`);};const clearMessages=(event)=>{event.stopPropagation();toggleMenu(event);let url=drupalSettings.path.baseUrl+'ajax/chatbot/reset-session/'+drupalSettings.ai_deepchat.assistant_id+'/'+drupalSettings.ai_deepchat.thread_id;fetch(url,{method:'POST',headers:{'Content-Type':'application/json'}}).then((response)=>{if(!response.ok)throw new Error('Failed to clear the chat history.');return response.json();}).then((data)=>{setThreadId(data.thread_id);drupalSettings.ai_deepchat.messages=[];deepchatElement.clearMessages(false);delete deepchatElement._activeService;deepchatElement.onRender();});};const handleError=(event)=>{deepchatElement.addMessage({role:'assistant',html:`<p>`+Drupal.t('You can retry your last message with this button:')+`</p>
            <div class="deep-chat-temporary-message">
        <button class="deep-chat-button deep-chat-suggestion-button" style="margin-top: 5px">`+Drupal.t("Retry last instruction")+`</button>
      </div>`});};const toggleChat=()=>{if(container.classList.contains('chat-open'))closeChat();else openChat();};const toggleMenu=(event)=>{event.stopPropagation();dropDownMenu.classList.toggle('active');chevron.classList.toggle('rotate');};header.addEventListener('click',toggleChat);header.addEventListener('keypress',(event)=>{if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleChat();}});const savedState=localStorage.getItem(`deepChatState_${chatId}`);if(savedState==='open')openChat();else closeChat();deepchatElement.addEventListener('error',handleError);deepchatElement.responseInterceptor=(response)=>{Drupal.behaviors.deepChatToggle.shouldContinue=response.should_continue||false;if(response.should_continue){Drupal.behaviors.deepChatToggle.stepMessages.push(response.html);const html=response.html;response.html='<div class="loading-wrapper"><span class="loading-span">'+Drupal.t('Contacting agents..')+'</span>';response.html+=`<details class="step-messages loading-text"><summary class="step-messages-summary">`;response.html+=Drupal.t('Details')+`</summary>`+html+`</details></div>`;}return response;};deepchatElement.onMessage=(message)=>{if(Drupal.behaviors.deepChatToggle.shouldContinue===true&&message.message.role==='ai'){Drupal.behaviors.deepChatToggle.shouldContinue=false;deepchatElement.disableSubmitButton();getAllMessages(deepchatElement);}};deepchatElement.requestInterceptor=async(request)=>{if(drupalSettings.ai_deepchat.session_exists===false&&!Drupal.behaviors.deepChatToggle.csrfToken){if(!Drupal.behaviors.deepChatToggle.csrfToken)Drupal.behaviors.deepChatToggle.csrfToken=await Drupal.behaviors.deepChatToggle.getSession();let newUrl=deepchatElement.connect.url.replace(/\?token=[^&]+/,'');deepchatElement.connect.url=newUrl+'?token='+Drupal.behaviors.deepChatToggle.csrfToken;}};deepchatElement.addEventListener('render',async()=>{pendingRenders--;deepchatElement.htmlClassUtilities['chat-button-link']={"styles":{"default":{"text-decoration":"none"}}};deepchatElement.htmlClassUtilities['chat-button']={"styles":{"default":{"width":"20px","height":"20px","display":"inline","float":"none","cursor":"pointer"}}};deepchatElement.htmlClassUtilities['loading-span']={"styles":{"default":{"color":"#555","animation":"pulse-color 2s infinite"}}};deepchatElement.htmlClassUtilities['step-messages']={events:{toggle:(event)=>{Drupal.behaviors.deepChatToggle.agentUsageIsOpen=event.target.open;}}},deepchatElement.htmlClassUtilities['loading-wrapper']={"styles":{"default":{"padding-bottom":"10px"}}},deepchatElement.htmlClassUtilities['loading-text']={"styles":{"default":{"color":"#888","font-style":"italic"}}};deepchatElement.htmlClassUtilities['structured-results-dump']={'styles':{'default':{'display':'none'}}};deepchatElement.htmlClassUtilities['structured-results']={'events':{'click':(event)=>{event.preventDefault();let details=event.target.closest('.message-bubble').querySelector('.structured-results-dump').cloneNode(true);Drupal.dialog(details,{'title':Drupal.t('Structured results'),'width':'auto','buttons':{'close':{'text':Drupal.t('Close'),'click':()=>{Drupal.dialog.close();}}}}).showModal();}}};deepchatElement.htmlClassUtilities['copy']={"events":{"click":(event)=>{event.preventDefault();let text=event.target.closest('.message-bubble').innerText;navigator.clipboard.writeText(text);}}};if(drupalSettings.ai_deepchat.messages.length>0){for(let message of drupalSettings.ai_deepchat.messages)deepchatElement.addMessage(message);}if(pendingRenders===0){const event=new CustomEvent('DrupalDeepchatInitialized',{detail:{chats:this.chats}});document.dispatchEvent(event);}});menuButton.addEventListener('click',toggleMenu);clearHistory.addEventListener('click',clearMessages);});},getSession:async function(){return new Promise((resolve,reject)=>{fetch(drupalSettings.path.baseUrl+'api/deepchat/session',{method:'POST'}).then((response)=>{if(!response.ok)resolve({error:'Failed to set session.'});return response.text();}).then((token)=>{Drupal.behaviors.deepChatToggle.csrfToken=token;resolve(token);});});}};function getAllMessages(deepchatElement){Drupal.behaviors.deepChatToggle.processing=true;const n=(deepchatElement.getMessages().length-1);fetch(deepchatElement.connect.url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({thread_id:drupalSettings.ai_deepchat.thread_id,assistant_id:drupalSettings.ai_deepchat.assistant_id,show_copy_icon:drupalSettings.ai_deepchat.show_copy_icon,structured_results:drupalSettings.ai_deepchat.structured_results,messages:[{role:'user',text:'dummy_loading'}]})}).then((response)=>{if(!response.ok)throw new Error('Failed to get messages.');return response.json();}).then((data)=>{if("should_continue" in data&&data.should_continue){Drupal.behaviors.deepChatToggle.stepMessages.push(data.html);let open=Drupal.behaviors.deepChatToggle.agentUsageIsOpen?'open':'';let html=`<div class="loading-wrapper"><span class="loading-span">`+Drupal.t('Calling agents..')+'</span>';html+=`<details class="step-messages loading-text" ${open}><summary class="step-messages-summary">`;html+=Drupal.t('Details')+`</summary>`+data.html+`</details></div>`;deepchatElement.updateMessage({role:'ai',html},n);getAllMessages(deepchatElement);}else{Drupal.behaviors.deepChatToggle.processing=false;Drupal.behaviors.deepChatToggle.agentUsageIsOpen=false;let details='';if(Drupal.behaviors.deepChatToggle.stepMessages.length>0){details=`<details class="step-messages loading-text"><summary class="step-messages-summary">`;details+=Drupal.t('Details')+`</summary><ol><li>`;details+=Drupal.behaviors.deepChatToggle.stepMessages.join('</li><li>');details+=`</li></ol></details>`;}if("error" in data)deepchatElement.updateMessage({role:'assistant',html:details+`<p>`+data.error+`</p>`},n);else deepchatElement.updateMessage({role:'ai',html:details+data.html},n);deepchatElement.disableSubmitButton(false);Drupal.behaviors.deepChatToggle.stepMessages=[];Drupal.behaviors.deepChatToggle.shouldContinue=false;}}).catch((error)=>{deepchatElement.updateMessage({role:'assistant',html:`<p>`+Drupal.t('An error occurred while fetching messages. Please try again.')+`</p>`},n);deepchatElement.disableSubmitButton(false);});window.addEventListener("beforeunload",function(e){if(Drupal.behaviors.deepChatToggle.processing){e.preventDefault();e.returnValue=Drupal.t("The chat is still processing. Are you sure you want to leave, it might still be modifying things?");}});}})(Drupal,drupalSettings);;
